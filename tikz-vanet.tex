\usetikzlibrary{%
	chains,
	calc,
	shapes,
	decorations,
	scopes,
	arrows,
	svg.path,
}

\tikzstyle{lane-right}=[start chain=going right,node distance=1ex]
\tikzstyle{lane-left}=[start chain=going left,node distance=1ex]

\newcommand\basicroad{%
% coordinates
\foreach \pos/\coord in {top/3ex, center/0, bottom/-3ex}{
\coordinate (\pos-left) at (0,\coord);
\coordinate (\pos-right) at (\textwidth-\pgflinewidth,\coord);
}

\coordinate (lane1-left) at (1,-1.5ex);
\path (\textwidth-\pgflinewidth,-1.5ex) +(-1,0) coordinate (lane1-right);
\coordinate (lane2-left) at (1,1.5ex);
\path (\textwidth-\pgflinewidth,1.5ex) +(-1,0) coordinate (lane2-right);

\coordinate (lane1) at (lane1-left);
\coordinate (lane2) at (lane2-right);

% basic road shape
\fill[road-fill] (top-left) rectangle (bottom-right);
\draw[road-draw] (top-left) -- (top-right);
\draw[road-draw,loosely dashed] (center-left) -- (center-right);
}

\newcommand\road{%
\basicroad
\draw[road-draw] (bottom-left) -- (bottom-right);
}

\newcommand\onramproad{%
\basicroad

% on-ramp bottom
\fill[road-fill] (bottom-left) -- ++(3,0) to[out=0,in=180] ++(1,-3ex) -- ++(3,0) coordinate (bend) to[out=0,in=135] ++(1,-3ex) -- ++(45:3ex) to[out=135,in=0] (bend |- bottom-left) -- cycle;

\draw[road-draw] (bottom-left) -- ++(3,0) coordinate (ramp-start) to[out=0,in=180] ++(1,-3ex) -- ++(3,0) coordinate (bend) to[out=0,in=135] ++(1,-3ex) ++(45:3ex) to[out=135,in=0] (bend |- bottom-left) coordinate (ramp-end) -- (bottom-right);

\draw[road-draw,dashed] (ramp-start) -- (ramp-end);
}

\tikzset{message/.style={->,shorten >=2pt,shorten <=2pt,line width=1pt}}

\newcommand\commwave[2]{%
\path[wave-fill] #1 circle (#2);
\path[wave-draw] #1 circle (#2);
}

\newcommand\accidentright{%
\accident{right}{0}
}

\newcommand\accident[2]{%
% accident
\path (lane1-#1) +(#2,0) coordinate (p1);
\path (lane2-#1) +(#2,0) coordinate (p2);

\path (p1) edge node[right,accident-star,minimum size=4ex] {} (p2);
\node[Car,rotate=30] at (p1) {};
\node[Car,rotate=-50] at (p2) {};
}

\newcommand\trafficjam[3][jam]{% begin point (right), #cars
\begin{scope}[lane-left,node distance=1.5ex]
	\path #2 node[Car,on chain] (#1-1) {};
	\foreach \i in {2,...,#3}{
	\node[Car,on chain] (#1-\i) {};
	}
\end{scope}
}


% Car
\tikzset{Car/.style={path picture={
\pgftransformscale{1em/10mm}
\fill[#1] svg "M28.21-13.605c9.562,3.446,9.648,23.671,0.155,27.315 c-4.363,0.507-11.834,0.663-14.102-0.052l-15.559,0.098c-0.361,0.54-2.344,0.587-2.49-0.046l-9.12-0.052 c-2.42,0.596-9.124,0.491-13.695,0.354c-0.868-0.069-2.466-0.383-3.055-0.86c-0.586-0.088-2.902-0.613-3.526-2.013 c-2.881-3.816-3.105-17.391-0.049-22.328c0.849-1.417,2.686-1.826,3.369-1.86c1.172-0.46,2.07-0.8,2.747-0.914 c4.707-0.249,12.097-0.404,14.099,0.304h9.073c0.314-0.542,2.336-0.684,2.805-0.049l15.296,0.103 C16.197-14.515,25.906-14.046,28.21-13.605z";%
\fill[CarWindow] svg "M-24.197,9.442c-0.964,0.555-2.364,1.198-2.94,1.826c7.256,0.867,22.892,1.016,38.82,1.092 c-1.101-0.841-5.213-1.443-8.749-2.128C-0.618,9.9-14.507,9.656-24.197,9.442z";%
\fill[CarWindow] svg "M33.182,7.616l-1.928,0.117c-0.877,1.522-1.91,4.131-4.51,5.058 c0.353,0.272,0.898,0.205,1.379,0.233C31.92,11.97,32.73,8.522,33.182,7.616z";%
\fill[CarWindow] svg "M-31.825-9.373c-2.358,4.111-2.324,14.41,0.069,18.753l4.252-0.791 c-2.718,0.159-2.64-17.187,0.057-17.171L-31.825-9.373z";%
\fill[CarWindow] svg "M14.187-11.443c-2.099,0.058-6.936,1.246-10.511,1.89C5.151-6.242,4.517,7.381,3.746,9.752 c3.689,0.599,8.887,1.858,10.498,1.517C18.698,9.763,18.805-9.979,14.187-11.443z";%
\fill[CarWindow] svg "M11.803-12.355c-15.93,0.087-31.488,0.225-38.756,1.103c0.581,0.619,1.916,1.206,2.886,1.758 c9.685-0.21,23.573-0.4,27.118-0.732C6.597-10.911,10.71-11.511,11.803-12.355z";%
\fill[CarWindow] svg "M27.243-13.147c-0.235,0.029-0.453,0.103-0.626,0.249c2.599,0.919,3.635,3.526,4.503,5.049 l1.934,0.127c-0.438-0.917-1.317-4.36-5.118-5.424C27.691-13.128,27.474-13.162,27.243-13.147z";%
},minimum width=2.5em,minimum height=1em},
Car/.default={black},
CarWindow/.style={fill=white},
}

\tikzset{Rsu/.style={path picture={
\pgftransformscale{3em/14mm}
\pgftransformrotate{180}
\fill[#1] svg "M5.188,18.438c-0.242,0-0.454-0.175-0.493-0.422L0.697-7.22C0.654-7.492,0.84-7.749,1.113-7.792
	c0.271-0.043,0.528,0.143,0.572,0.416l3.998,25.235c0.043,0.272-0.143,0.529-0.416,0.572C5.241,18.436,5.214,18.438,5.188,18.438z";
\fill[#1] svg "M-5.624,18.74c-0.026,0-0.053-0.002-0.08-0.006c-0.272-0.044-0.458-0.301-0.414-0.573L-1.682-9.34
	c0.043-0.272,0.299-0.461,0.573-0.414c0.272,0.044,0.458,0.301,0.414,0.573L-5.131,18.32C-5.17,18.565-5.383,18.74-5.624,18.74z";
\fill[#1] svg "M-5.019,17.469c-0.163,0-0.322-0.079-0.418-0.226c-0.151-0.231-0.087-0.541,0.144-0.692l9.001-5.911
	c0.23-0.151,0.541-0.087,0.692,0.144c0.151,0.231,0.087,0.541-0.144,0.692l-9.001,5.911C-4.83,17.442-4.925,17.469-5.019,17.469z";
\fill[#1] svg "M4.583,17.263c-0.094,0-0.189-0.026-0.273-0.082l-8.649-5.663c-0.231-0.151-0.295-0.461-0.145-0.692
	c0.152-0.23,0.461-0.295,0.692-0.145l8.649,5.663c0.231,0.151,0.295,0.461,0.145,0.692C4.906,17.183,4.746,17.263,4.583,17.263z";
\fill[#1] svg "M-3.774,10.612c-0.157,0-0.312-0.074-0.409-0.211c-0.159-0.226-0.105-0.538,0.12-0.697l6.807-4.806
	C2.97,4.74,3.282,4.793,3.441,5.018c0.159,0.226,0.105,0.538-0.12,0.697l-6.807,4.806C-3.574,10.583-3.674,10.612-3.774,10.612z";
\fill[#1] svg "M3.63,10.612c-0.1,0-0.2-0.03-0.288-0.092l-6.875-4.855c-0.226-0.159-0.279-0.471-0.12-0.697
	c0.159-0.226,0.471-0.279,0.697-0.12l6.875,4.855c0.226,0.159,0.279,0.471,0.12,0.697C3.941,10.539,3.787,10.612,3.63,10.612z";
\fill[#1] svg "M-2.935,4.747c-0.143,0-0.285-0.061-0.384-0.179c-0.177-0.212-0.149-0.527,0.062-0.704l5.195-4.346
	C2.152-0.66,2.466-0.63,2.643-0.419C2.82-0.208,2.792,0.108,2.58,0.285L-2.615,4.63C-2.708,4.709-2.822,4.747-2.935,4.747z";
\fill[#1] svg "M2.792,4.747c-0.113,0-0.227-0.038-0.32-0.116l-5.198-4.347C-2.938,0.107-2.966-0.208-2.79-0.42
	c0.177-0.21,0.492-0.24,0.705-0.063l5.198,4.347c0.212,0.177,0.24,0.493,0.063,0.705C3.077,4.686,2.935,4.747,2.792,4.747z";
\fill[#1] svg "M-0.005-12.703c-1.03,0.001-1.999,0.404-2.726,1.135C-3.459-10.84-3.858-9.87-3.856-8.827
	c0.005,2.123,1.735,3.851,3.857,3.851h0.006c1.03-0.002,1.998-0.405,2.726-1.135c0.727-0.73,1.126-1.699,1.125-2.741
	C3.853-10.976,2.123-12.703-0.005-12.703z";
\fill[#1] svg "M-4.533-3.745c-0.083,0-0.168-0.021-0.247-0.065c-1.347-0.765-2.315-2.009-2.726-3.502
	c-0.411-1.494-0.215-3.057,0.552-4.404c0.492-0.865,1.201-1.591,2.05-2.1c0.237-0.142,0.543-0.065,0.686,0.171
	c0.142,0.237,0.065,0.544-0.171,0.686c-0.702,0.421-1.288,1.021-1.695,1.738c-0.634,1.114-0.796,2.408-0.457,3.643
	C-6.202-6.342-5.4-5.313-4.286-4.68c0.24,0.136,0.324,0.441,0.188,0.682C-4.19-3.836-4.359-3.745-4.533-3.745z";
\fill[#1] svg "M-5.88-1.348c-0.083,0-0.168-0.021-0.246-0.065c-1.986-1.125-3.416-2.956-4.025-5.156c-0.609-2.2-0.325-4.505,0.799-6.492
	c0.723-1.274,1.77-2.35,3.025-3.109C-6.09-16.313-5.782-16.236-5.64-16c0.143,0.236,0.067,0.544-0.169,0.687
	c-1.11,0.671-2.034,1.621-2.673,2.747c-0.993,1.753-1.244,3.789-0.706,5.731c0.538,1.943,1.8,3.56,3.554,4.553
	c0.241,0.136,0.325,0.441,0.189,0.682C-5.536-1.439-5.706-1.348-5.88-1.348z";
\fill[#1] svg "M-7.574,1.059c-0.088,0-0.177-0.023-0.257-0.071c-2.627-1.581-4.482-4.089-5.223-7.065c-0.74-2.975-0.277-6.061,1.303-8.689
	c0.958-1.591,2.303-2.94,3.892-3.9c0.237-0.144,0.544-0.067,0.687,0.169c0.143,0.236,0.067,0.544-0.169,0.687
	c-1.45,0.877-2.679,2.108-3.553,3.561c-1.442,2.399-1.865,5.216-1.189,7.932c0.675,2.716,2.369,5.006,4.768,6.449
	c0.236,0.143,0.313,0.45,0.171,0.687C-7.239,0.972-7.405,1.059-7.574,1.059z";
\fill[#1] svg "M4.536-3.745c-0.174,0-0.343-0.091-0.435-0.253C3.964-4.238,4.048-4.543,4.289-4.68c1.113-0.633,1.914-1.662,2.253-2.898
	c0.34-1.235,0.178-2.53-0.456-3.644c-0.404-0.712-0.99-1.313-1.694-1.738c-0.237-0.143-0.313-0.45-0.17-0.686
	c0.142-0.238,0.45-0.314,0.686-0.17c0.851,0.513,1.56,1.239,2.048,2.101c0.766,1.346,0.961,2.91,0.551,4.403
	c-0.41,1.493-1.377,2.737-2.723,3.502C4.705-3.766,4.62-3.745,4.536-3.745z";
\fill[#1] svg "M5.882-1.348c-0.174,0-0.344-0.091-0.436-0.253C5.31-1.841,5.395-2.146,5.635-2.283c3.62-2.05,4.897-6.664,2.848-10.285
	c-0.64-1.127-1.564-2.077-2.674-2.746c-0.236-0.143-0.312-0.45-0.17-0.687c0.143-0.237,0.449-0.313,0.687-0.17
	c1.256,0.758,2.302,1.833,3.027,3.109c2.322,4.101,0.875,9.326-3.224,11.648C6.05-1.369,5.965-1.348,5.882-1.348z";
\fill[#1] svg "M7.576,1.059c-0.17,0-0.335-0.086-0.429-0.242C7.005,0.58,7.082,0.272,7.318,0.13c4.95-2.978,6.555-9.429,3.576-14.381
	c-0.873-1.451-2.101-2.683-3.55-3.561c-0.236-0.143-0.312-0.451-0.168-0.687c0.144-0.236,0.451-0.311,0.687-0.168
	c1.587,0.962,2.932,2.311,3.889,3.9c3.263,5.425,1.505,12.492-3.917,15.753C7.753,1.036,7.664,1.059,7.576,1.059z";
},minimum width=2.2em,minimum height=3em},
Rsu/.default=black}


% Server

\tikzset{Server/.style={path picture={
\pgftransformscale{3em/100cm}
\pgftransformyscale{-1}
\fill[#1] (-34.646,-26.568) -- (-34.648,36.998) -- (-5.069,42.52) -- (-5.069,-22.815) -- cycle;
\fill[white] (-18.734,37.15) -- (-21.861,36.579) -- (-21.861,7.092) -- (-18.734,7.43) -- cycle;
\fill[white] (-9.257,5.562) -- (-30.484,2.862) -- (-30.484,-3.595) -- (-9.257,-0.895) -- cycle;
\fill[white] (-9.257,-3.595) -- (-30.484,-6.296) -- (-30.484,-12.754) -- (-9.257,-10.053) -- cycle;
\fill[white] (-9.257,-12.755) -- (-30.484,-15.456) -- (-30.484,-21.914) -- (-9.257,-19.212) -- cycle;
\fill[#1] (-4.187,-24.749) -- (32.57,-39.392) -- (7.907,-42.52) -- (-32.506,-28.34) -- cycle;
\fill[#1] (-3.039,-23.021) -- (-3.039,42.166) -- (34.648,21.965) -- (34.648,-38.036) -- cycle;
},minimum width=3em,minimum height=3em},
Server/.default=black}
